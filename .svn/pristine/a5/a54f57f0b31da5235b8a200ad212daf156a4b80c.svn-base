/*错题本*/
topicCont.controller('classroomWrongCont',['$scope','$timeout','$stateParams','$ionicSlideBoxDelegate','topicContHttpService','topicContService','$window',function($scope,$timeout,$stateParams,$ionicSlideBoxDelegate,topicContHttpService,topicContService,$window){
    $scope.currentTopic=1;//初始化题序数为1
    $scope.currentRead=1;//阅读理解双view题序数为1
    $scope.isLoading=true;//加载动作
    $scope.isMoreprompt=false;//没有更多提示文字
    //$scope.isMore=true;
    //获取错题本下题目
    var loginToken=GetQueryString("loginToken"),
    	stageId=GetQueryString("stageId"),//学段ID
   	    subjectId=GetQueryString("subjectId"),//学科
   	    pageNumber=0,
   	    pageSize=10,
   	    wrongCollectCont="";//走接口获取的数据赋给到这-用来作为移除或取消收藏之后重新渲染一下视图数据
   	    requestWrongData(loginToken,stageId,subjectId,pageNumber,pageSize);
   	    var wrongCont=[];//定义一个数组用来存储每次刷新加载的错题数据
   		function requestWrongData(loginToken,stageId,subjectId,pageNumber,pageSize){
	    	topicContHttpService.getClassroomWrong(loginToken,stageId,subjectId,pageNumber,pageSize).then(function(res){
	   			var data=res.data;
	   			console.log(data)
	   			if(data.result){
	   					$scope.isLoading=false;//加载动作
	   					//通知客户端结束loading
   						window.errorCollect.finishLoading(1);
		   				if(data.data.content.length>1||data.data.content.length==1){
		   					wrongCont=wrongCont.concat(data.data.content);//每次上拉加载数据，往数组里面添加新刷新的数据
		   					$scope.$broadcast('scroll.infiniteScrollComplete');
		   					$scope.isMore=true;
		   				}else{
		   					$scope.isMore=false;
		   					$scope.isMoreprompt=true;//没有更多提示文字
		   				}
		   				for (var i = 0; i < wrongCont.length; i++) {
		   					//转换单选题类型格式
		   					var wrongQuestion = wrongCont[i],
		   						questionInfo = wrongQuestion.questionInfo;
		   					if(questionInfo.type == 0){
	   							//转换选项类型格式
	   							var options=questionInfo.options!=null&&questionInfo.options!='' ? JSON.parse(questionInfo.options) : [],
	   								chartName=["A","B","C","D","E","F","G","H","I","J","K","L","M","N"];
	   								questionInfo.option=[];
	   								for (var j = 0; j < options.length; j++) {
	   									var optionsObj={"title":chartName[j],"option":options[j]};
	   										questionInfo.option.push(optionsObj);
	   								}
		   						

		   					}
		   					//转换多选题类型格式
		   					if(questionInfo.type == 1){
	   							//转换选项类型格式
	   							var options=questionInfo.options!=null&&questionInfo.options!='' ? JSON.parse(questionInfo.options) : [],
	   								chartName=["A","B","C","D","E","F","G","H","I","J","K","L","M","N"];
	   								questionInfo.option=[];
	   								for (var j = 0; j < options.length; j++) {
	   									var optionsObj={"title":chartName[j],"option":options[j]};
	   										questionInfo.option.push(optionsObj);
	   								}

		   					}
		   					//转换多问题类型格式
		   					if(questionInfo.type == 4){
		   							wrongQuestion.questionInfo.doubleViewTopicNum=wrongQuestion.questionInfo.questionInfoList!=null&&wrongQuestion.questionInfo.questionInfoList.length!=0 ? wrongQuestion.questionInfo.questionInfoList.length : 0;//双view下的题目的数量
		   							var exerciseId=wrongQuestion.id;//定义一个练习id的变量存储给双view套页面用-方便
		   							var questionInfoList=wrongQuestion.questionInfo.questionInfoList;//双view下的题的内容数据
		   							if(questionInfoList!=null&&questionInfoList.length!=0){
										for (var j = 0; j < questionInfoList.length; j++) {
			   								if(questionInfoList[j].type == 0){
				   								//转换选项类型格式
					   							var options=questionInfoList[j].options!=null&&questionInfoList[j].options!='' ? JSON.parse(questionInfoList[j].options) : [],
					   								chartName=["A","B","C","D","E","F","G","H","I","J","K","L","M","N"];
					   								questionInfoList[j].option=[];
					   								for (var m = 0; m < options.length; m++) {
					   									var optionsObj={"title":chartName[m],"option":options[m]};
					   										questionInfoList[j].option.push(optionsObj);
					   								}
					   						
						   					}
						   					//转换多选题类型格式
						   					if(questionInfoList[j].type == 1){
					   							//转换选项类型格式
					   							var options=JSON.parse(questionInfoList[j].options),
					   								chartName=["A","B","C","D","E","F","G","H","I","J","K","L","M","N"];
					   								questionInfoList[j].option=[];
					   								for (var m = 0; m < options.length; m++) {
					   									var optionsObj={"title":chartName[m],"option":options[m]};
					   										questionInfoList[j].option.push(optionsObj);
					   								}
					   						
						   							
						   					}
						   					//给双view下小题都给加个练习id方便提交答案时候用参数
					   						questionInfoList[j].exerciseId=exerciseId;
						   					//双view下-转换考点类型格式
						   					if(!!questionInfoList[j].knowledges){
						   						questionInfoList[j].parseKnowledges = [];
					   							questionInfoList[j].parseKnowledges=questionInfoList[j].knowledges.split(",");
						   					}
			   							}
		   							}
		   							
		   							
		   					}
		   					//所有题型-转换考点类型格式
		   					if(!!questionInfo.knowledges){
		   						questionInfo.parseKnowledges = [];
	   							questionInfo.parseKnowledges=questionInfo.knowledges.split(",");
		   					}
		   				}
		   				console.log(wrongCont)
		   				$scope.wrongCont=wrongCont;
		   				wrongCollectCont=wrongCont;//走接口获取的数据赋给到这-用来作为移除或取消收藏之后重新渲染一下视图数据
		   				$ionicSlideBoxDelegate.update();
		   				
		   				//数据渲染之后
		   				$timeout(function(){
					    	//下面的view视图拖拽效果
					    	//$scope.noMore=true;
							function drag(){
								// 获取节点
								var block = document.getElementsByClassName("directory-read-multiple-choice");
								var oW,oH;
								    // 绑定touchstart事件
								    for (var i = 0; i < block.length; i++) {
								   	block[i].addEventListener("touchstart", function(e) {
									   e.preventDefault();
									   e.stopPropagation();
									   var touches = e.touches[0];
									   oH = touches.clientY - this.offsetTop;
									   //阻止页面的滑动默认事件
									   document.addEventListener("touchmove",defaultEvent,false);
									},false)
									block[i].addEventListener("touchmove", function(e) {
									   e.preventDefault();
									   e.stopPropagation();
									   var touches = e.touches[0];
									   var oTop = touches.clientY - oH;
									   if(oTop < 70) {
									      oTop = 70;
									   }else if(oTop > document.documentElement.clientHeight - 150) {
									    oTop = (document.documentElement.clientHeight - 150);
									   }
									   this.style.top = oTop + "px";
									},false);
									block[i].addEventListener("touchend",function() {
									   document.removeEventListener("touchmove",defaultEvent,false);
									},false);
									function defaultEvent(e) {
									   e.preventDefault();
									  }
								    }
							}
							drag(); 
							/*初始化一进来就告诉安卓上一次答题时间*/
						/*	var durationSecond=$(".directory-slide").attr("data-durationSecond");//上次答题时间
		   						console.log(parseInt(durationSecond))
					    		window.errorCollect.startKeepingTime(parseInt(durationSecond));*/

					    	/*每次滑动的时候告诉安卓这道题是否被收藏过*/
				  			var questionId=$(".directory-slide").eq(0).attr("data-questionId"),//题目问题ID
				  				isCollection=$(".directory-slide").eq(0).attr("data-isStart");//是否被收藏的布尔值 true是收藏 false没收藏
				  				console.log(questionId,isCollection)
				  				if(isCollection=='true'){   
				                    isCollection=true;
				                }else{   
				                    isCollection=false;  
				                }  
				  				window.errorCollect.isStartQuestion(parseInt(questionId),isCollection,parseInt(0));
					    })
		   		}
	   		})
		}
		
	/*上拉加载*/
	$scope.loadMoreData=function(){
    	console.log("到底部刷新了")
    	pageNumber=pageNumber+=1;
    	console.log(pageNumber)
    	requestWrongData(loginToken,stageId,subjectId,pageNumber,pageSize);
    }
	/*安卓告诉H5哪道题移除*/
    isDelWrongtopic=function(questionId,count){
    	var questionId=questionId;
    	
		//从列表中移除此道题目
		$(".directory-slide-list").each(function(){
			var self=$(this),
				id=self.attr("data-questionId");
				if(id==questionId){
					self.remove();
					$timeout(function(){
						//如果移除或者取消收藏就遍历下全部数据移除掉此questionId数据-重新渲染视图
						for (var i = 0; i < wrongCollectCont.length; i++) {
							if(wrongCollectCont[i].questionId==questionId){
								wrongCollectCont.splice(i,1);
								$scope.wrongCont=wrongCollectCont;
							}
						}
					},100)
				}
		})

    }
	/*安卓告诉H5哪道题是否被收藏过的方法*/
	isNocollection=function(questionId,isStart,index){//将函数定义为全局函数
		var isStartBool=isStart;
                if(isStartBool=='true'){   
                    isStartBool=true;
                }else{   
                    isStartBool=false;  
                }  
            $(".directory-slide").eq(parseInt(index)).attr({"data-questionId":parseInt(questionId),"data-isStart":isStartBool});
	};

}]);
